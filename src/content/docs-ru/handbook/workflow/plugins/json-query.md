# JSON-анализ

<PluginInfo name="workflow-json-query" link="/handbook/workflow/plugins/json-query" commercial="true"></PluginInfo>

Используется для анализа сложных JSON-данных, созданных некоторыми узлами, чтобы их можно было использовать в последующих узлах. Например, результаты операций SQL и HTTP-запросов могут быть представлены в формате JSON. Этот узел позволяет разобрать их на необходимые значения и переменные для дальнейшего использования.

<embed src="../../../_partials/commercial-installation.md"></embed>

## Руководство по использованию

### Создание узла

В интерфейсе конфигурации рабочего процесса нажмите кнопку плюс ("+") в процессе, чтобы добавить узел "JSON-анализ":

![Создание узла](https://static-docs.nocobase.com/7de796517539ad9dfc88b7160f1d0dd7.png)

:::info{title=Подсказка}
Обычно узел JSON-анализа создается под другими узлами данных для удобства их обработки.
:::

### Настройка узла

#### Движок анализа

Узел JSON-анализа поддерживает различные движки анализа для работы с разными синтаксисами. Выбор движка может зависеть от ваших предпочтений и особенностей каждого движка. В настоящее время поддерживаются три движка анализа:

- [JMESPath](https://jmespath.org/)
- [JSONPath Plus](https://jsonpath-plus.github.io/JSONPath/docs/ts/)
- [JSONata](https://jsonata.org/)

![Выбор движка анализа](https://static-docs.nocobase.com/29be3b92a62b7d20312d1673e749f2ec.png)

#### Источник данных

Источником данных может быть результат узла выше по потоку или объект данных из контекста процесса. Обычно это неструктурированный объект данных, например, результат SQL-узла или HTTP-запроса.

![Источник данных](https://static-docs.nocobase.com/f5a97e20693b3d30b3a994a576aa282d.png)

:::info{title=Подсказка}
Объекты данных, связанные с узлами таблиц, как правило, уже структурированы с помощью конфигурации таблицы, поэтому обычно их не нужно анализировать с помощью узла JSON-анализа.
:::

#### Выражение для анализа

Пользовательское выражение для анализа настраивается на основе потребностей и выбранного движка анализа.

![Выражение для анализа](https://static-docs.nocobase.com/181abd162fd32c09b62f6aa1d1cb3ed4.png)

:::info{title=Подсказка}
Разные движки анализа предоставляют разные синтаксисы. Подробную информацию можно найти в документации по ссылкам.
:::

#### Сопоставление атрибутов

Если результат анализа представляет собой объект (или массив объектов), через сопоставление атрибутов можно дополнительно отобразить нужные атрибуты в виде дочерних переменных для использования в последующих узлах.

![Сопоставление атрибутов](https://static-docs.nocobase.com/b876abe4ccf6b4709eb8748f21ef3527.png)

:::info{title=Подсказка}
Для результата в виде объекта (или массива объектов), если не выполнено сопоставление атрибутов, весь объект (или массив объектов) будет сохранен как одна переменная в результате узла, и значения атрибутов объекта нельзя будет использовать напрямую как переменные.
:::

### Пример

Предположим, что данные для анализа являются результатом предыдущего SQL-узла, который используется для запроса данных, и его результат представляет собой набор данных заказов:

```json
[
  [
    {
      "id": 1,
      "products": [
        {
          "id": 1,
          "title": "Product 1",
          "price": 100,
          "quantity": 1
        },
        {
          "id": 2,
          "title": "Product 2",
          "price": 120,
          "quantity": 2
        }
      ]
    },
    {
      "id": 2,
      "products": [
        {
          "id": 3,
          "title": "Product 3",
          "price": 130,
          "quantity": 1
        },
        {
          "id": 4,
          "title": "Product 4",
          "price": 140,
          "quantity": 2
        }
      ]
    }
  ]
]
```

:::info{title=Примечание}
Вышеупомянутый внешний массив не является ошибкой, а представляет собой нормальный результат SQL-узла, поскольку результат SQL-узла — это двумерный массив, где первый элемент содержит строки результата запроса, а второй элемент содержит метаданные запроса.
:::

Если нам нужно проанализировать и рассчитать общую стоимость двух заказов из данных, а затем собрать объект с соответствующими ID заказов для обновления общей стоимости заказа, можно настроить следующим образом:

![Пример-Настройка анализа SQL](https://static-docs.nocobase.com/e62322a868b26ff98120bfcd6dcdb3bd.png)

1. Выберите движок анализа JSONata;
2. Укажите результат SQL-узла как источник данных;
3. Используйте выражение JSONata `$[0].{"id": id, "total": products.(price * quantity)}` для анализа;
4. Настройте сопоставление атрибутов, отобразив `id` и `total` в качестве дочерних переменных;

Итоговый результат анализа будет следующим:

```json
[
  {
    "id": 1,
    "total": 340
  },
  {
    "id": 2,
    "total": 410
  }
]
```

После этого можно использовать цикл для обработки массива завершенных заказов и обновления общей стоимости каждого заказа.

![Обновление общей стоимости соответствующих заказов](https://static-docs.nocobase.com/b3329b0efe4471f5eed1f0673bef740e.png)
