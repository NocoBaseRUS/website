# Внешние вызовы

Триггер пользовательских операционных событий не ограничивается действиями в пользовательском интерфейсе, его также можно вызвать через HTTP API. В частности, для всех операций с таблицами данных пользовательские операционные события предоставляют новый тип операции для запуска рабочих процессов: `trigger`, который может быть вызван с использованием стандартного API операций NocoBase.

Например, рабочий процесс, запускаемый кнопкой, как в примере, можно вызвать следующим образом:

```bash
curl -X POST -H 'Authorization: Bearer <your token>' -H 'X-Role: <roleName>' \
  "http://localhost:3000/api/samples:trigger/<:id>?triggerWorkflows=workflowKey"
```

Поскольку операция выполняется для одной записи данных, при вызове для существующих данных необходимо указать ID строки данных, заменив часть `<:id>` в URL.

Если вызов производится для формы (например, для добавления или обновления), то для новой записи ID можно не передавать, но необходимо предоставить отправляемые данные в качестве контекстных данных для выполнения:

```bash
curl -X POST -H 'Authorization: Bearer <your token>' -H 'X-Role: <roleName>' -d \
  '{
    "title": "Sample 1",
    "indicator": 91
  }'
  "http://localhost:3000/api/samples:trigger?triggerWorkflows=workflowKey"
```

Для обновления формы необходимо одновременно передать ID строки данных и данные для обновления:

```bash
curl -X POST -H 'Authorization: Bearer <your token>' -H 'X-Role: <roleName>' -d \
  '{
    "title": "Sample 1",
    "indicator": 91
  }'
  "http://localhost:3000/api/samples:trigger/<:id>?triggerWorkflows=workflowKey"
```

Если одновременно переданы ID и данные, сначала будет загружена строка данных, соответствующая ID, а затем свойства из переданного объекта данных будут использованы для перезаписи исходных данных строки. В результате будет получен окончательный контекст данных для запуска.

:::warning{title="Внимание"}
Если переданы связанные данные, они также будут перезаписаны. Особенно это касается случаев, когда настроена предварительная загрузка связанных данных. Будьте осторожны при обработке входящих данных, чтобы избежать непредвиденной перезаписи связанных данных.
:::

Кроме того, параметр URL `triggerWorkflows` — это ключ рабочего процесса. Несколько рабочих процессов разделяются запятыми. Этот ключ можно получить, наведя курсор на название рабочего процесса в верхней части холста рабочего процесса:

![Способ просмотра ключа рабочего процесса](https://static-docs.nocobase.com/20240426135108.png)

После успешного выполнения вышеуказанного вызова будет запущено пользовательское операционное событие, соответствующее таблице `samples`.

:::info{title="Подсказка"}
Так как внешний вызов также требует идентификации пользователя, при вызове через HTTP API, как и при отправке обычных запросов через интерфейс, необходимо предоставлять данные аутентификации, включая заголовок запроса `Authorization` или параметр `token` (полученный при входе в систему), а также заголовок запроса `X-Role` (имя текущей роли пользователя).
:::

Если необходимо запустить события для связанных данных "один-к-одному" (поддержка "один-ко-многим" пока не реализована) в рамках этой операции, можно использовать символ `!` в параметрах для указания данных, которые должны быть использованы для триггера связанного поля:

```bash
curl -X POST -H 'Authorization: Bearer <your token>' -H 'X-Role: <roleName>' \
  "http://localhost:3000/api/posts:trigger/<:id>?triggerWorkflows=workflowKey!category"
```

После успешного выполнения вышеуказанного вызова будет запущено пользовательское операционное событие, соответствующее таблице `categories`.

:::info{title="Подсказка"}
При вызове событий через HTTP API после операций также следует учитывать состояние активации рабочего процесса и настройки соответствия таблицы данных. В противном случае вызов может завершиться неудачей или возникнет ошибка.
:::
