# Пример

На основе описанного выше процесса конфигурации, рассмотрим пример расчета итоговой цены с применением различных правил скидок для товаров в процессе оформления заказа.

1. Создание таблицы товаров:

    | Имя поля   | Тип                      |
    | ---------- | ------------------------- |
    | Название товара | Текст                  |
    | Базовая цена | Число                    |
    | Правило скидки | `belongsTo` (таблица правил скидок) |

2. Создание таблицы правил скидок (созданной на основе шаблона таблицы выражений):

    | Имя поля   | Тип                     |
    | ---------- | ------------------------ |
    | Название правила | Текст                 |
    | Таблица данных | Выбор одного (таблица)  |
    | Вычислительный движок | Выбор одного (mathjs/formulajs) |
    | Выражение  | Текст                   |

3. Ввод правил скидок:

    | ID  | Название      | Таблица данных | Вычислительный движок | Выражение                |
    | --- | ------------- | -------------- | --------------------- | ------------------------ |
    | 1   | Товар со скидкой 20% | Товары        | formula.js           | `{{Товары.цена}} * 0.8` |
    | 2   | Товар со скидкой 10% | Товары        | formula.js           | `{{Товары.цена}} * 0.9` |

4. Создание товаров и связывание с правилами скидок:

    | ID  | Название товара      | Цена  | Правило скидки |
    | --- | ------------------- | ----- | -------------- |
    | 1   | iPhone 14 Pro       | 7999  | 2              |
    | 2   | iPhone 13 Pro       | 6999  | 1              | 


5. Создайте рабочий процесс, который будет запускаться при создании заказа:

    ![Триггер_Создание заказа](https://static-docs.nocobase.com/f181f75b10007afd5de068f3458d2e04.png)

6. Создайте узел динамического вычисления выражений и настройте динамическое выражение для данных триггера/товара/правила скидки:

    ![Выбор данных динамического выражения](https://static-docs.nocobase.com/21ccc63e604dd90b7d26c3c33c12d671.png)

    Настройте источник данных переменных из товаров в данных триггера:

    ![Выбор источника данных переменных](https://static-docs.nocobase.com/afbffe9661539d26e4b175ae8a4b28f7.png)

7. Добавьте узел обновления данных и настройте обновление общей стоимости заказа, используя результат вычислительного узла:

    ![Обновление данных заказа](https://static-docs.nocobase.com/5cc7ffb113c8d6a2fd3b1b34abe06dcc.png)

8. Создайте заказ, который запустит рабочий процесс, затем проверьте список заказов и сверьте цены:

    | Товар в заказе      | Исходная цена товара в заказе | Правило скидки | Общая сумма             |
    | ------------------- | ---------------------------- | -------------- | ----------------------- |
    | iPhone 14 Pro       | 7999                         | 10% скидка     | 7999 * 0.9 = 7199.1     |
    | iPhone 13 Pro       | 6999                         | 20% скидка     | 6999 * 0.8 = 5599.2     |

    Итоговая сумма в таблице ниже должна соответствовать общей сумме в таблице выше:

    ![Автоматически рассчитанная итоговая сумма заказа после его создания](https://static-docs.nocobase.com/a5610aca292e79c4841c97457bd3cc7c.png)

    :::info{title=Подсказка}
    Поскольку рабочий процесс выполняется асинхронно, сразу после создания заказа и обновления таблицы итоговая сумма может не отображаться. Подождите некоторое время и обновите таблицу, чтобы увидеть итоговую сумму.
    :::
