# Продвинутое использование

## Условия для перехвата операций

В "событиях перед операцией" есть два условия, которые могут привести к перехвату соответствующей операции:

1. Выполнение процесса до любого узла "Завершение процесса". Например, если данные, запустившие процесс, не удовлетворяют предустановленным условиям в узле "Условное ветвление", поток переходит на ветку "Нет" и выполняется узел "Завершение процесса". В этом случае процесс завершается, а запрошенная операция перехватывается.
2. Ошибка выполнения любого узла в процессе, включая ошибки при выполнении узла или другие аномальные ситуации. В таком случае процесс завершается с соответствующим статусом, и запрошенная операция также будет перехвачена. Например, если в процессе есть вызов внешних данных через узел "HTTP-запрос", и запрос завершается неудачно, то процесс завершится с ошибкой, а соответствующий запрос операции также будет перехвачен.

После выполнения условий перехвата соответствующая операция больше не будет выполнена. Например, если отправка заказа была перехвачена, соответствующие данные заказа не будут созданы.

## Соответствующие параметры операции

В рабочих процессах типа "события перед операцией" для разных операций триггер предоставляет различные данные, которые могут использоваться как переменные в процессе:

| Тип операции \\ Переменные | "Оператор"       | "Идентификатор роли оператора" | Параметр операции: "ID" | Параметр операции: "Объект отправленных данных" |
| -------------------------- | --------------- | ----------------------------- | ----------------------- | ---------------------------------------------- |
| Создание записи            | ✓               | ✓                             | -                       | ✓                                              |
| Обновление записи          | ✓               | ✓                             | ✓                       | ✓                                              |
| Удаление одной или нескольких записей | ✓         | ✓                             | ✓                       | -                                              |-                          |

:::info{title=Подсказка}
Переменная "Данные триггера / Параметры операции / Объект отправленных данных" в событиях перед операцией не является фактическими данными из базы данных, а представляет собой только параметры, отправленные с операцией. Если требуются реальные данные из базы данных, необходимо выполнить запрос через узел "Запрос данных" в процессе.

Кроме того, для операции удаления: если действие выполняется для одной записи, параметр "ID" будет простым значением, а если для нескольких записей — параметр "ID" будет массивом.
:::

## Настройка вывода сообщения ответа

После настройки триггера можно добавить в рабочий процесс пользовательскую логику принятия решений. Обычно используется режим ветвления узла "Условное ветвление", чтобы в зависимости от бизнес-условий выбрать, завершать ли процесс, и вернуть предопределенное "Сообщение ответа":

![Настройка перехватывающего процесса](https://static-docs.nocobase.com/cfddda5d8012fd3d0ca09f04ea610539.png)

На этом настройка соответствующего рабочего процесса завершена. Теперь можно попробовать отправить данные, которые не удовлетворяют условиям, настроенным в узле "Условное ветвление", чтобы активировать логику перехвата. При этом будет видно возвращаемое сообщение ответа:

![Сообщение об ошибке в ответе](https://static-docs.nocobase.com/06bd4a6b6ec499c853f0c39987f63a6a.png)

#### Статус сообщения ответа

Сообщение ответа может возвращать следующие статусы:

- Успех (Success): Операция выполнена успешно, и запрос был обработан без ошибок.
- Ошибка (Error): Запрос не выполнен из-за ошибки, например, если условие не выполнено или произошел сбой при выполнении процесса.
- Предупреждение (Warning): Запрос выполнен частично или с предупреждением, но основная операция все еще может считаться успешной.

Эти статусы помогают пользователям понимать результат выполнения операции и принимать соответствующие решения.

Если в узле "Завершение процесса" настроено завершение с состоянием "Успех", и выполнение доходит до этого узла, то запрос операции все равно будет перехвачен. Однако возвращаемое сообщение ответа будет отображаться со статусом "Успех" (а не "Ошибка"):

![Сообщение ответа со статусом успеха](https://static-docs.nocobase.com/9559bbf56067144759451294b18c790e.png)

Это позволяет использовать перехват для управления логикой процесса, при этом возвращая положительный результат пользователю, если бизнес-условия выполняются корректно. Такой подход может быть полезен, например, для информирования пользователя о том, что его запрос был обработан должным образом, но дальнейшие действия были намеренно остановлены на основании определенных условий.
