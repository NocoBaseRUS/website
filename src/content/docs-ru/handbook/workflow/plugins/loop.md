# Цикл

<PluginInfo name="workflow-loop" link="/handbook/workflow/plugins/loop"></PluginInfo>

Цикл аналогичен структурам `for`/`while`/`forEach` в языках программирования. Когда требуется повторять определенные операции несколько раз или для набора данных (массива), можно использовать узел цикла.

## Установка

Встроенный плагин, установка не требуется.

## Руководство по использованию

### Создание узла

В интерфейсе конфигурации рабочего процесса нажмите кнопку плюс ("+") в процессе, чтобы добавить узел "Цикл":

![Создание узла цикла](https://static-docs.nocobase.com/b3c8061a66bfff037f4b9509ab0aad75.png)

После создания узла цикла будет сгенерирована внутренняя ветка цикла, в которую можно добавить любое количество узлов. Эти узлы могут использовать переменные контекста процесса, а также локальные переменные контекста цикла, например, объект данных, полученный на каждой итерации цикла, или индекс итераций (индекс начинается с `0`). Область действия локальных переменных ограничена внутренней частью цикла. При вложенных циклах можно использовать конкретные локальные переменные каждого уровня.

### Настройка узла

#### Объект цикла

Цикл обрабатывает объекты цикла по-разному в зависимости от их типа данных:

1. **Массив**: Наиболее распространенный случай, обычно можно выбрать переменные контекста процесса, например, результаты запросов нескольких строк данных узла запроса или предварительно загруженные данные отношений "один-ко-многим". Если выбран массив, узел цикла будет перебирать каждый элемент массива, и на каждой итерации текущий элемент будет присвоен локальной переменной контекста цикла.

2. **Число**: Когда выбранная переменная является числом, этот номер используется как количество итераций цикла. Индекс количества итераций в локальных переменных также является значением объекта цикла.

3. **Строка**: Если выбранная переменная является строкой, длина строки определяет количество итераций цикла. На каждой итерации обрабатывается символ строки по индексу.

4. **Другое**: Значения других типов (включая объекты) обрабатываются только как однократный цикл, то есть цикл выполнится один раз. Обычно в этом случае использование цикла не требуется.

Помимо выбора переменной, для чисел и строк также можно вводить константы напрямую. Например, если ввести `5` (числового типа), узел цикла выполнит 5 итераций; если ввести `abc` (строкового типа), узел цикла выполнит 3 итерации, обрабатывая символы `a`, `b`, `c`. Выберите нужный тип константы в инструменте выбора переменных.

### Пример

Например, при оформлении заказа необходимо проверить наличие на складе каждого товара в заказе. Если запасы достаточны, они будут уменьшены, в противном случае товар в деталях заказа будет помечен как недействительный.

1. Создайте три таблицы: "Товары" <-(1:m)-- "Детали заказа" --(m:1)-> "Заказы". Модель данных выглядит следующим образом:

    | Название поля | Тип поля         |
    | -------------- | ---------------- |
    | Детали товаров | Многие-к-одному (детали) |
    | Общая стоимость заказа | Число           |

    | Название поля | Тип поля          |
    | ------------- | ----------------- |
    | Товар         | Один-ко-многим (товары) |
    | Количество    | Число             |

    | Название поля | Тип поля   |
    | ------------- | ---------- |
    | Название товара | Однострочный текст |
    | Цена          | Число      |
    | Запасы        | Целое число|

2. Создайте рабочий процесс, выберите триггер "Событие таблицы данных", выберите событие "При добавлении данных" для таблицы "Заказы" и настройте предварительную загрузку связанных данных из таблицы "Детали заказа" и товаров:

    ![Пример_конфигурация триггера циклического узла](https://static-docs.nocobase.com/0086601c2fc0e17a64d046a4c86b49b7.png)

3. Создайте узел цикла, выбрав объект цикла как "Данные триггера / Детали заказа", то есть каждую запись в таблице "Детали заказа":

    ![Пример_конфигурация циклического узла](https://static-docs.nocobase.com/2507becc32db5a9a0641c198605a20da.png)

4. Внутри узла цикла создайте узел "Условное суждение", чтобы проверить, достаточно ли запасов товара:

    ![Пример_конфигурация условного узла цикла](https://static-docs.nocobase.com/a6d08d15786841e1a3512b38e4629852.png)

5. Если запасов достаточно, создайте узел "Вычисление" и узел "Обновление данных" в ветке "Да", чтобы вычислить и обновить остатки товара:

    ![Пример_конфигурация вычислительного узла](https://static-docs.nocobase.com/8df3604c71f8f8705b1552d3ebfe3b50.png)

    ![Пример_конфигурация узла обновления запасов](https://static-docs.nocobase.com/2d84baa9b3b01bd85fccda9eec992378.png)

6. В противном случае, в ветке "Нет" создайте узел "Обновление данных", чтобы изменить статус деталей заказа на "Недействительно":

    ![Пример_конфигурация узла обновления деталей заказа](https://static-docs.nocobase.com/4996613090c254c69a1d80f3b3a7fae2.png)

Общая структура процесса представлена на рисунке ниже:

![Пример_структура процесса циклического узла](https://static-docs.nocobase.com/6f59ef246c1f19976344a7624c4c4151.png)

После завершения настройки и активации процесса при создании нового заказа автоматически проверяются запасы товаров в деталях заказа. Если запасов достаточно, они уменьшаются; в противном случае товары в деталях заказа помечаются как недействительные (для расчета действительной общей стоимости заказа).