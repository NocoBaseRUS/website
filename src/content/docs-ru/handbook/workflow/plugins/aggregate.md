# Агрегатные запросы

<PluginInfo name="workflow-aggregate" link="/handbook/workflow/plugins/aggregate"></PluginInfo>

Используется для выполнения агрегатных запросов к данным таблицы, соответствующим определенным условиям, и возвращает соответствующие статистические результаты. Часто применяется для обработки статистических данных, связанных с отчетами.

Реализация узла основана на агрегатных функциях базы данных. В настоящее время поддерживается только статистика по одному полю одной таблицы данных. Результаты статистики сохраняются в результатах узла для использования в последующих узлах.

## Установка

Встроенный плагин, установка не требуется.

## Руководство по использованию

### Создание узла

В интерфейсе конфигурации рабочего процесса нажмите кнопку плюс ("+") в процессе, чтобы добавить узел "Агрегатный запрос":

![Создание узла агрегатного запроса](https://static-docs.nocobase.com/7f9d806ebf5064f80c30f8b67f316f0f.png)

### Настройка узла

![Узел агрегатного запроса_Настройка узла](https://static-docs.nocobase.com/57362f747b9992230567c6bb5e986fd2.png)

#### Агрегатные функции

Поддерживаются следующие пять агрегатных функций SQL: `COUNT`, `SUM`, `AVG`, `MIN` и `MAX`. Выберите одну из них для выполнения агрегатного запроса к данным.

#### Тип цели

Цель агрегатного запроса можно выбрать двумя способами: либо напрямую выбрать целевую таблицу данных и одно из её полей, либо использовать данные объекта, уже имеющегося в контексте процесса, выбрав связанную таблицу данных и поле для выполнения агрегатного запроса.

#### Удаление дубликатов

Эквивалентно `DISTINCT` в SQL. Поле для удаления дубликатов должно совпадать с выбранным полем таблицы данных; поддержка выбора разных полей временно отсутствует.

#### Условия фильтрации

Аналогично условиям фильтрации при обычном запросе к таблице данных, можно использовать переменные контекста процесса.

### Пример

Цель агрегации в виде "данных таблицы" довольно проста для понимания. Здесь мы рассмотрим пример подсчёта общего количества статей в категории после добавления новой статьи, где целью агрегации являются "данные связанной таблицы".

Во-первых, создаются две таблицы данных: "Статьи" и "Категории". В таблице "Статьи" есть поле отношения многие-к-одному, указывающее на таблицу категорий, а также обратное отношение один-ко-многим, связывающее категории со статьями:

| Имя поля | Тип |
| -------- | --- |
| Заголовок | Однострочный текст |
| Категория | Многие-к-одному (Категории) |

| Имя поля | Тип |
| -------- | --- |
| Название категории | Однострочный текст |
| Содержащиеся статьи | Один-ко-многим (Статьи) |

Далее создаётся рабочий процесс, запускаемый событием таблицы данных, который активируется после добавления новой записи в таблицу статей.

После этого добавляется узел агрегатного запроса, настроенный следующим образом:

![Узел агрегатного запроса_Пример_Настройка узла](https://static-docs.nocobase.com/542272e638c6c0a567373d1b37ddda78.png)

Таким образом, после запуска рабочего процесса узел агрегатного запроса подсчитает количество всех статей в категории новой статьи и сохранит результат как выходные данные узла.