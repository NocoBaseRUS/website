# Расширение типов аутентификации

## Обзор

NocoBase поддерживает расширение типов пользовательской аутентификации в зависимости от потребностей. Аутентификация пользователей обычно делится на два типа: один выполняется внутри приложения NocoBase, например, вход по паролю или вход через SMS; другой тип предполагает проверку личности пользователя сторонним сервисом с последующим уведомлением приложения NocoBase о результате через обратный вызов, например, аутентификация по OIDC или SAML. В NocoBase процессы аутентификации этих двух типов выглядят следующим образом:

### Без использования стороннего обратного вызова

1. Клиент использует SDK NocoBase для вызова интерфейса входа `api.auth.signIn()`, отправляя запрос на интерфейс `auth:signIn` и передавая идентификатор текущего аутентификатора через заголовок запроса `X-Authenticator`.
2. Интерфейс `auth:signIn` на основе идентификатора аутентификатора из заголовка запроса перенаправляет запрос к соответствующему типу аутентификации. Логика обработки выполняется методом `validate`, зарегистрированным в классе аутентификации.
3. Клиент получает информацию о пользователе и токен аутентификации из ответа интерфейса `auth:signIn`. Токен сохраняется в Local Storage, завершая процесс входа. Этот шаг автоматически обрабатывается внутри SDK.

<img src="https://static-docs.nocobase.com/202404211852848.png"/>

### С использованием стороннего обратного вызова

1. Клиент получает URL для входа через сторонний сервис, используя собственный зарегистрированный интерфейс (например, `auth:getAuthUrl`) и передавая такие данные, как имя приложения и идентификатор аутентификатора.
2. Происходит переход по URL стороннего сервиса для завершения входа. Затем сторонний сервис вызывает обратный вызов приложения NocoBase (необходимо зарегистрировать, например, `auth:redirect`), возвращая результат аутентификации, а также данные, такие как имя приложения и идентификатор аутентификатора.
3. Метод обратного вызова анализирует параметры для получения идентификатора аутентификатора, использует `AuthManager` для получения соответствующего класса аутентификации и активно вызывает метод `auth.signIn()`. Метод `auth.signIn()` вызывает метод `validate()` для обработки логики аутентификации.
4. Метод обратного вызова получает токен аутентификации и выполняет перенаправление на клиентскую страницу с кодом 302, добавляя в URL параметры токена и идентификатора аутентификатора: `?authenticator=xxx&token=yyy`.

<img src="https://static-docs.nocobase.com/202404211852377.png"/>

Далее описывается, как регистрировать серверные интерфейсы и клиентский пользовательский интерфейс.

## Серверная часть

### Интерфейс аутентификации

Ядро NocoBase предоставляет регистрацию и управление расширяемыми типами аутентификации. Основная логика обработки плагинов расширенного входа требует наследования абстрактного класса `Auth` ядра и реализации соответствующих стандартных интерфейсов.  
Полное описание API см. в [Auth](../../../api/auth/auth.md).

```typescript
import { Auth } from '@nocobase/auth';

class CustomAuth extends Auth {
  set user(user) {}
  get user() {}

  async check() {}
  async signIn() {}
}
```

Ядро также регистрирует базовые операции с ресурсами, связанные с аутентификацией пользователей.

| API            | Описание               |
| -------------- | ---------------------- |
| `auth:check`   | Проверка, авторизован ли пользователь |
| `auth:signIn`  | Вход в систему         |
| `auth:signUp`  | Регистрация           |
| `auth:signOut` | Выход из системы       |

В большинстве случаев расширенные типы аутентификации пользователей могут использовать существующую логику JWT для генерации учетных данных пользователя при доступе к API. Класс `BaseAuth` ядра предоставляет базовую реализацию абстрактного класса `Auth`. См. [BaseAuth](../../../api/auth/base-auth.md). Плагины могут напрямую наследовать класс `BaseAuth`, чтобы повторно использовать часть логики кода и снизить затраты на разработку.

```javascript
import { BaseAuth } from '@nocobase/auth';

class CustomAuth extends BaseAuth {
  constructor(config: AuthConfig) {
    // Установка таблицы данных пользователей
    const userCollection = config.ctx.db.getCollection('users');
    super({ ...config, userCollection });
  }

  // Реализация логики аутентификации пользователей
  async validate() {}
}
```

### Данные пользователей

При реализации логики аутентификации пользователей обычно требуется обработка данных пользователей. В приложении NocoBase по умолчанию используются следующие определения таблиц:

| Таблицы данных         | Назначение                                                    | Плагин                                                                 |
| ---------------------- | ------------------------------------------------------------- | ---------------------------------------------------------------------- |
| `users`                | Хранит информацию о пользователях: email, псевдоним и пароль    | [Плагин пользователей (`@nocobase/plugin-users`)](../../users/index.md) |
| `authenticators`       | Хранит информацию об аутентификаторах (сущности типов аутентификации) и их конфигурацию | Плагин аутентификации пользователей (`@nocobase/plugin-auth`)           |
| `usersAuthenticators`  | Связывает пользователей с аутентификаторами, сохраняет информацию о пользователях для соответствующих аутентификаторов | Плагин аутентификации пользователей (`@nocobase/plugin-auth`)           |

В большинстве случаев для расширения способов входа достаточно использовать таблицы `users` и `usersAuthenticators` для хранения соответствующих данных пользователей. Только в особых случаях может потребоваться добавление новой коллекции.

Основные поля таблицы `usersAuthenticators`:

| Поле            | Описание                                                |
| --------------- | ------------------------------------------------------- |
| `uuid`          | Уникальный идентификатор пользователя для данного типа аутентификации, например, номер телефона или openid WeChat |
| `meta`          | Поле JSON, для хранения другой необходимой информации   |
| `userId`        | ID пользователя                                         |
| `authenticator` | Имя аутентификатора (уникальный идентификатор)          |

Для операций запроса и создания пользователей, модель данных `authenticators` (`AuthModel`) предоставляет несколько методов, которые можно использовать в классе `CustomAuth` через `this.authenticator[имяМетода]`. Полное описание API см. в [AuthModel](../dev/api.md#authmodel).

```ts
import { AuthModel } from '@nocobase/plugin-auth';

class CustomAuth extends BaseAuth {
  async validate() {
    // ...
    const authenticator = this.authenticator as AuthModel;
    this.authenticator.findUser(); // Запрос пользователей
    this.authenticator.newUser(); // Создание нового пользователя
    this.authenticator.findOrCreateUser(); // Поиск или создание нового пользователя
    // ...
  }
}
```

### Регистрация типа аутентификации

Расширенный метод аутентификации необходимо зарегистрировать в модуле управления аутентификацией.。

```javascript
class CustomAuthPlugin extends Plugin {
  async load() {
    this.app.authManager.registerTypes('custom-auth-type', {
      auth: CustomAuth,
    });
  }
}
```

## Клиентская часть

Пользовательский интерфейс клиента регистрируется через интерфейс `registerType`, предоставляемый клиентской частью плагина аутентификации пользователей:

```ts
import AuthPlugin from '@nocobase/plugin-auth/client';

class CustomAuthPlugin extends Plugin {
  async load() {
    const auth = this.app.pm.get(AuthPlugin);
    auth.registerType('custom-auth-type', {
      components: {
        SignInForm, // Форма входа
        SignInButton, // Кнопка входа (для сторонних сервисов), может быть выбрана вместо формы входа
        SignUpForm, // Форма регистрации
        AdminSettingsForm, // Форма администрирования
      },
    });
  }
}
```

### Форма входа

![](https://static-docs.nocobase.com/33afe18f229c3db45c7a1921c2c050b7.png)

Если для нескольких аутентификаторов зарегистрированы формы входа, они будут отображаться в виде вкладок (Tab). Заголовки вкладок соответствуют заголовкам аутентификаторов, настроенных в административной панели.

![](https://static-docs.nocobase.com/ada6d7add744be0c812359c23bf4c7fc.png)

### Кнопка входа

![](https://static-docs.nocobase.com/e706f7785782adc77b0f4ee4faadfab8.png)

Обычно это кнопка входа через сторонний сервис, но может быть любым компонентом.

### Форма регистрации

![](https://static-docs.nocobase.com/f95c53431bf21ec312fcfd51923f0b42.png)

Если требуется перейти со страницы входа на страницу регистрации, это нужно обработать внутри компонента входа.

### Форма администрирования

![](https://static-docs.nocobase.com/f4b544b5b0f5afee5621ad4abf66b24f.png)

В верхней части находится общая конфигурация аутентификатора, а в нижней — часть формы, предназначенная для пользовательской конфигурации.

### Интерфейс запросов

Для выполнения запросов, связанных с аутентификацией пользователей на стороне клиента, можно использовать SDK, предоставляемый NocoBase.

```ts
import { useAPIClient } from '@nocobase/client';

// use in component
const api = useAPIClient();
api.auth.signIn(data, authenticator);
```

Подробное описание API см. в [@nocobase/sdk - Auth](../../../api/sdk/auth.md).